apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-scripts
  namespace: feaf-dashboard
  labels:
    app: feaf-postgres
    component: database
data:
  01-init-database.sql: |
    -- Initialize FEAF Dashboard Database
    -- This script runs automatically when the database is first created
    
    -- Create extensions if needed
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    
    -- Set timezone
    SET timezone = 'UTC';
    
    -- Create indexes for better performance (Prisma will create tables)
    -- These will be created after Prisma migrations run
    
    -- Log initialization
    DO $$
    BEGIN
      RAISE NOTICE 'FEAF Dashboard database initialized successfully';
    END $$;
  
  02-performance-tuning.sql: |
    -- Performance tuning for PostgreSQL
    -- These settings optimize for the FEAF Dashboard workload
    
    -- Adjust shared buffers (25% of available memory)
    ALTER SYSTEM SET shared_buffers = '256MB';
    
    -- Adjust effective cache size (50% of available memory)
    ALTER SYSTEM SET effective_cache_size = '512MB';
    
    -- Adjust work memory for sorting and hashing
    ALTER SYSTEM SET work_mem = '16MB';
    
    -- Adjust maintenance work memory for VACUUM and CREATE INDEX
    ALTER SYSTEM SET maintenance_work_mem = '128MB';
    
    -- Enable query planning improvements
    ALTER SYSTEM SET random_page_cost = 1.1;
    
    -- Adjust checkpoint settings for better write performance
    ALTER SYSTEM SET checkpoint_completion_target = 0.9;
    ALTER SYSTEM SET wal_buffers = '16MB';
    
    -- Enable auto-vacuum for better maintenance
    ALTER SYSTEM SET autovacuum = on;
    ALTER SYSTEM SET autovacuum_max_workers = 3;
    
    -- Log slow queries (queries taking more than 1 second)
    ALTER SYSTEM SET log_min_duration_statement = 1000;
    
    -- Log connections and disconnections for monitoring
    ALTER SYSTEM SET log_connections = on;
    ALTER SYSTEM SET log_disconnections = on;
    
    -- Reload configuration
    SELECT pg_reload_conf();
    
    DO $$
    BEGIN
      RAISE NOTICE 'PostgreSQL performance tuning applied';
    END $$;
